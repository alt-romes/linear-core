
% ROMES: Note that the \Delta env only has linear variables by construction;
% usage environments only record linear variables.
\begin{lemma}[Substitution of variables with usage environments preserves typing]
\emph{If $\G, \D, \xD \vdash e : \varphi$ and $\G', \D \vdash e' : \sigma$ and
    $\hasnolinearvars{\G'}$ then $\G, \G', \D \vdash e[e'/x] : \varphi$}
\end{lemma}
\begin{proof}
By structural induction on the first derivation.

\begin{description}

\item[Case:] $Contract_\omega$
\begin{tabbing}
    (1) $\G, \D, \xD, \yo \vdash e : \vp$\\
    (2) $\G', \D \vdash e' : \s$\\
    (3) $\hasnolinearvars{\G'}$\\
    (4) $\G, \D, \xD, \yo, \yo \vdash e : \vp$\` by inv. on $Contract_\omega$\\
    (5) $\G, \G', \D, \yo, \yo \vdash e[e'/x] : \vp$\` by induction hypothesis (2,3,4)\\
    (6) $\G, \G', \D, \yo \vdash e[e'/x] : \vp$\` by $Contract_\omega$\\
\end{tabbing}

\item[Case:] $Weaken_\omega$
\begin{tabbing}
    (1) $\G, \D, \xD, \yo \vdash e : \vp$\\
    (2) $\G', \D \vdash e' : \s$\\
    (3) $\hasnolinearvars{\G'}$\\
    (4) $\G, \D, \xD, \vdash e : \vp$\` by inv. on $Weaken_\omega$\\
    (5) $\G, \G', \D, \vdash e[e'/x] : \vp$\` by induction hypothesis (2,3,4)\\
    (6) $\G, \G', \D, \yo \vdash e[e'/x] : \vp$\` by $Weaken_\omega$\\
\end{tabbing}

\item[Case:] $Weaken_\Delta$
\begin{tabbing}
    (1) $\G, \D, \xD, \yD \vdash e : \vp$\\
    (2) $\G', \D \vdash e' : \s$\\
    (3) $\hasnolinearvars{\G'}$\\
    (4) $\G, \D, \xD, \vdash e : \vp$\` by inv. on $Weaken_\Delta$\\
    (5) $\G, \G', \D, \vdash e[e'/x] : \vp$\` by induction hypothesis (2,3,4)\\
    (6) $\G, \G', \D, \yD \vdash e[e'/x] : \vp$\` by $Weaken_\Delta$\\
    (-) TODO. Do we need the subcase where x being weakened is the x being
    substituted?\\
\end{tabbing}

\item[Case:] $Var_\omega$
\begin{tabbing}
    (1) $\G, \cdot, \yo, \xD \vdash y : \s'$\\
    (2) $\G', \cdot \vdash e' : \s'$\\
    (3) $\hasnolinearvars{\G'}$\\
    (4) $y[e'/x] = y$\\
    (5) $\G, \cdot, \yo \vdash y : \s'$\\
\end{tabbing}

\item[Case:] $Var_1$
\begin{tabbing}
    (1) Impossible.
\end{tabbing}

\item[Case:] $Var_\Delta$
\begin{tabbing}
    (1) $\cdot, \D, \xD \vdash x : \s$\\
    (2) $\G', \D \vdash e' : \s$\\
    (3) $\hasnolinearvars{\G'}$\\
    (4) $x[e'/x] = e'$\\
    (5) $\cdot, \G', \D \vdash e' : \s$\` by (2)\\
\end{tabbing}

\item[Case:] $\Lambda I$
\begin{tabbing}
    (1) $\G,\D, \xD \vdash \Lambda p.~e : \forall p.~\vp$\\
    (2) $\G', \D' \vdash e' : \s$\\
    (3) $\hasnolinearvars{\G'}$\\
    (4) $\G, p, \D, \xD \vdash e : \vp$ \` by inversion on $\Lambda I$\\
    (5) $\G, \G', \D, p \vdash e[e'/x]$ \` by induction hypothesis (2,3,4)\\
    (6) $\G, \G', \D \vdash \Lambda p.~e[e'/x] : \forall p.~\vp$ \` by $\Lambda I$ \\
    (7) $(\Lambda p.~e)[e'/x] = (\Lambda p.~e[e'/x])$ \` by def. of subst.\\
    (8) $\G, \G', \D \vdash (\Lambda p.~e)[e'/x] : \forall p.~\vp$ \` by (5,6)\\
\end{tabbing}

\item[Case:] $\Lambda E$
\begin{tabbing}
    (1) $\G, \D, \xD \vdash e~\pi : \vp$\\
    (2) $\G', \D \vdash e' : \s$\\
    (3) $\hasnolinearvars{\G'}$\\
    (4) $\G, \D, \xD \vdash e : \forall p.~\vp$ \` by inversion on $\Lambda E$\\
    (5) $\G, \D \vdash_{mult} \pi$ \` by inversion on $\Lambda E$\\
    (6) $\G, \G', \D, \xD$ \` by induction hypothesis (2,3,4)\\
    (7) $\G, \G', \D \vdash e[e'/x]~\pi : \vp$ by $\Lambda E$\\
    (8) $(e~\pi)[e'/x] = (e[e'/x]~\pi)$ \` by def. of subst.\\
    (7) $\G, \G', \D \vdash (e~\pi)[e'/x] : \vp$ by (6,7)\\
\end{tabbing}

\item[Case:] $\lambda I$
\begin{tabbing}
    (1) $\G, \D, \xD \vdash \lambda \y[\pi][\s'].~e : \s' \to_\pi \vp$\\
    (2) $\G', \D \vdash e' : \s$\\
    (3) $\hasnolinearvars{\G'}$\\
    (4) $\G, \D, \xD, \y[\pi][\s'] \vdash e : \vp$ \` by inversion on $\lambda I$\\
    (5) $\G, \G', \D, \y[\pi][\s'] \vdash e[e'/x] : \vp$ \` by induction hypothesis (2,3,4)\\
    (6) $\G, \G', \D \vdash \lambda \y[\pi][\s'].~e[e'/x] : \s' \to_\pi \vp$ \` by $\lambda I$\\
    (7) $(\lambda \y[\pi][\s'].~e[e'/x]) = (\lambda \y[\pi][\s'].~e)[e'/x]$ \` by def. of subst.\\
    (8) $\G, \G', \D \vdash \lambda (\y[\pi][\s'].~e)[e'/x] : \s' \to_\pi \vp$ \` by (5,6)\\
\end{tabbing}

\item[Case:] $\lambda E_{1,p}$
\begin{tabbing}
    (1) $\G,\G'',\D,\xD \vdash e~e'' : \varphi$\\
    (2) $\G',\D \vdash e' : \sigma$\\
    (3) $\hasnolinearvars{\G'}$\\
    Subcase $\xD$ occurs in $e$\\
    (4) $\G,\D,\xD \vdash e : \s' \to_{1,p} \vp$\\
    (5) $\G'' \vdash e'' : \s'$\\
    (6) $\G,\G',\D\vdash e[e'/x] : \s' \to_{1,p} \vp$ \` by i.h.\\
    (7) $\G,\G',\D,\G'' \vdash e[e'/x]~e'' : \vp$\` by ($\lambda E_{1,p}$)\\
    (8) $(e[e'/x]~e'')=(e~e'')[e'/x]$\` since $x$ does not occur in $e''$\\
    Subcase $\xD$ occurs in $e''$\\
    (4) $\G \vdash e : \s' \to_{1,p} \vp$\\
    (5) $\G'',\D,\xD \vdash e'' : \s'$\\
    (6) $\G'',\D,\G' \vdash e''[e'/x] : \s'$\` by i.h.\\
    (7) $\G'',\G,\G',\D \vdash (e~e''[e'/x]) : \vp$\` by ($\lambda E_{1,p}$)\\
    (8) $e~e''[e'/x] = (e~e'')[e'/x]$\`since $x$ does not occur in $e$\\

\end{tabbing}

\item[Case:] $\lambda E_\omega$
\begin{tabbing}
    (1) $\G, \G'', \D, \xD \vdash e~e'' : \vp$\\
    (2) $\G', \D \vdash e' : \s$\\
    (3) $\hasnolinearvars{\G'}$\\
    (4) $\hasnolinearvars{\G''}$\` by inv. on $\lambda E_\omega$\\
    (5) $\D$ cannot occur in $e''$\\
    (6) $\G, \D, \xD \vdash e : \s' \to_\omega \vp$\` by inv. on $\lambda E_\omega$\\
    (7) $\G'' \vdash e'' : \s'$ \` by inv. on $\lambda E_\omega$\\
    (8) $\G, \G', \D \vdash e[e'/x] : \s' \to_\omega \vp$ \` by induction hypothesis (2,3,6)\\
    (9) $\G, \G', \G'', \D \vdash e[e'/x]~e'' : \vp$\` by $\lambda E_\omega$ (4,7,8)\\
    (10) $e[e'/x]~e'' = (e~e'')[e'/x]$\` $x$ does not occur in $e''$ by (5)\\
\end{tabbing}

\item[Case:] $Let$
\begin{tabbing}
    (1) $\G',\D \vdash e' : \s$\\
    (2) $\hasnolinearvars{\G'}$\\
    Subcase $\xD$ occurs in $e$\\
    (3) $\G, \G'', \D', \D, \xD \vdash \llet{\y[\D,\D'][\s'] = e}{e''} : \vp$\\
    (4) $\G'',\D', \D, \xD \vdash e : \s'$\` by inversion on (let)\\
    (5) $\G,\D',\D,\y[\D,\D'][\s'] \vdash e'' : \vp$\` by inversion on (let)\\
    (6) $\hasnolinearvars{\G''}$\` by inversion on (let)\\
    (7) $\G',\D',\G'',\D \vdash e[e'/x] : \s'$\` by induction hypothesis (1,2,4)\\
    (8) $\G,\G',\G'',\D,\D' \vdash \llet{\y[\D,\D'][\s'] = e[e'/x]}{e''} : \vp$\` by (let) (5,6,7,2)\\
    (9) $\llet{\y[\D,\D'][\s'] = e[e'/x]}{e''} = (\llet{\y[\D,\D'][\s'] = e}{e''})[e'/x]$\` since $x$ does not occur in $e''$\\
    Subcase $\xD$ occurs in $e''$\\
    (3) $\G, \G'', \D', \D, \xD \vdash \llet{\y[\D'][\s'] = e}{e''} : \vp$\\
    (4) $\G'',\D' \vdash e : \s'$\` by inversion on (let)\\
    (5) $\G,\D',\y[\D'][\s'],\D,\xD \vdash e'' : \vp$\` by inversion on (let)\\
    (6) $\hasnolinearvars{\G''}$\` by inversion on (let)\\
    (7) $\G,\G',\D',\y[\D'][\s'],\D \vdash e''[e'/x] : \vp$\` by i.h. (1,2,5)\\
    (8) $\G,\G',\G'',\D,\D' \vdash \llet{\y[\D'][\s'] = e}{e''[e'/x]} : \vp$\` by (let)\\
    (9) $\llet{\y[\D'][\s'] = e}{e''[e'/x]} = (\llet{\y[\D'][\s'] = e}{e''})[e'/x]$\` since $x$ does not occur in $e$\\
\end{tabbing}

\end{description}

\end{proof}

