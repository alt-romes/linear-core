
\begin{theorem}[Type preservation]
\emph{If $\Gamma \vdash e : \sigma$ and $e \to^* e'$ then $\Gamma \vdash e' : \sigma$}
\end{theorem}

\begin{proof}
By structural induction on the small-step reduction.

%   \begin{description}
%   \item[Case:] $\imp$-{\sc param}
%     \begin{tabbing}
%       $\Delta \vdash \alpha \imp \alpha$ \` this case\\
%       $\TERASE{\Delta}{\alpha} = t_I$, with $\bounds_\Delta(\alpha) =
%       t_I(\ov{\tau})$ \` by definition\\
%       $t_I \imp t_I$ \` by rule $\imp_I$
%     \end{tabbing}
%
%   \item[Case:] ...

\begin{description}

\item[Case:] $(\lambda x{:}_\pi\sigma.~e)~e' \longrightarrow e[e'/x]$
\begin{tabbing}
  (1) $\Gamma, \Gamma' \vdash (\lambda x{:}_\pi\sigma.~e)~e' : \varphi$ \` by assumption \\
  (2) $\Gamma \vdash (\lambda x{:}_\pi\sigma.~e) : \sigma\to_\pi\varphi$ \` by inversion on ($\lambda E$) \\
  (3) $\Gamma, x{:}_\pi\sigma \vdash e : \varphi$ \` by inversion on ($\lambda I$) \\
  (4) $\Gamma' \vdash e' : \sigma$ \` by inversion on ($\lambda E$) \\
  (5) $\Gamma, \Gamma' \vdash e[e'/x] : \varphi$ \` by subst. lemma (3,4) \\
\end{tabbing}

\item[Case:] $(\Lambda p.~e)~\pi \longrightarrow e[\pi/p]$
\begin{tabbing}
(1) $\Gamma \vdash (\Lambda p.~e)~\pi : \sigma[\pi/p]$ \` by assumption \\
(2) $\Gamma \vdash (\Lambda p.~e) : \forall p.~\sigma$ \` by inversion on ($\Lambda E$) \\
(3) \` $\Gamma \vdash_{mult} \pi$ \` by inversion on ($\Lambda E$) \\
(4) $\Gamma, p \vdash e : \sigma$ \` by inversion on ($\Lambda I$) \\
% TODO: How to use these inversions
(5) $p \notin \Gamma$ \` by inversion on ($\Lambda I$) \\
(6) $\Gamma \vdash e[\pi/p]:\sigma[\pi/p]$ \` by subst. lemma (3,4) \\
\end{tabbing}

\item[Case:] $\llet{x{:}_\Delta\sigma = e}{e'}\longrightarrow e'[e/x]$
\begin{tabbing}
(1) $\Gamma \vdash \llet{x{:}_\Delta\sigma = e}{e'} : \varphi$ \` by assumption \\
(2) $\Gamma, x{:}_\Delta\sigma \vdash e' : \varphi$ \` by inversion on (let) \\
(3) $\Delta \vdash e : \sigma$ \` by inversion on (let) \\
(4) $\Delta \subseteq \Gamma$ \` by inversion on (let) \\
(5) $\Gamma \vdash e'[e/x] : \varphi$ \` by subst. lemma (2,3,4?) \\
\end{tabbing}

\item[Case:] $\llet{\overline{x{:}_\Delta\sigma = e}}{e'} \longrightarrow e'\overline{[\lletrec{\overline{x{:}_\Delta\sigma = e}}{e}/x]}$
\begin{tabbing}
(1) $\Gamma \vdash \llet{\overline{x{:}_\Delta\sigma = e}}{e'} : \varphi$ \` by assumption \\
(2) $\Gamma, \overline{x{:}_\Delta\sigma} \vdash e : \varphi$ \` by inversion on (letrec) \\
(3) $\overline{\Delta, \overline{x{:}_\Delta\sigma \vdash e' : \sigma}}$ \` by inversion on (letrec) \\
(4) $\overline{\Delta\subseteq\Gamma}$ \` by inversion on (letrec) \\
(5) $\Gamma \vdash e'\overline{[\lletrec{\overline{x{:}_\Delta\sigma = e}}{e}/x]}$ \` by subst. lemma (2,3,4?) \\
\end{tabbing}

\item[Case:] $\ccase{K~\overline{e}}{z{:}_{\overline{\Delta}}\sigma}~\{\dots,K~\overline{x{:}_\pi\sigma}\}\ \longrightarrow e'[\overline{e}/\overline{x}][K~\overline{e}/z]$
\begin{tabbing}
(1) $\Gamma,\Gamma' \vdash \ccase{K~\overline{e}}{z{:}_{\overline{\Delta}}\sigma~\{\dots,K~\overline{x{:}_\pi\sigma}\to e'\}} : \varphi$ \` by assumption \\
(2) $\Gamma \vdash K~\overline{e} : \sigma$ \` by inversion on (case) \\
(3) $\Gamma', z{:}_\Delta\sigma \vdash_{alt} K~\overline{x{:}_\pi\sigma} \to e' : \sigma \Longrightarrow \varphi$ \` by inversion on (case) \\
% TODO: Como Ã© que uso estes casos
(4) $K : \overline{\sigma \to_\pi} T~\overline{p} \in \Gamma'$ \` by inversion on (alt) \\
(5) $\Gamma',z{:}_\Delta\sigma,\overline{x{:}_\pi\sigma} \vdash e' : \varphi$ \` by inversion on (alt) \\
% TODO: Delta_i?
(6) $\Gamma, z{:}_{\Delta_i}\sigma, \Gamma' \vdash e'[\overline{e}/\overline{x}] : \varphi$ \` by subst. lemma (2,5) \\
% TODO: HOW? Missing something (inversion on case). Hard!
(7) $\Gamma, \Gamma' \vdash e'[\overline{e}/\overline{x}][???/z]$ \` by subst. lemma (6,2) \\
\end{tabbing}

\item[Case:] $e_1~e_2 \longrightarrow e_1'~e_2$
\begin{tabbing}
(1) $e_1 \longrightarrow e_1'$ \` by inversion on $\beta$-reduction \\
(2) $\Gamma,\Gamma' \vdash e_1~e_2 : \varphi$ \` by assumption \\
(3) $\Gamma \vdash e_1 : \sigma \to_\pi \varphi$ \` by inversion on ($\lambda E$) \\
(4) $\Gamma' \vdash e_2 : \sigma$ \` by inversion on ($\lambda E$) \\
(5) $\Gamma \vdash e_1' : \sigma \to_\pi \varphi$ \` by induction hypothesis in (3,1) \\
(6) $\Gamma, \Gamma' \vdash e_1'~e_2 : \varphi$ \` by ($\lambda E$) (4,3) \\
\end{tabbing}

\item[Case:] $e~\pi \longrightarrow e'~\pi$
\begin{tabbing}
(1) $e \longrightarrow e'$ \` by inversion on mult. $\beta$-reduction \\
(2) $\Gamma \vdash e~\pi : \sigma[\pi/p]$ \` by assumption \\
(3) $\Gamma \vdash e : \forall p.~\sigma$ \` by inversion on ($\Lambda E$) \\
(4) $\Gamma \vdash_{mult} \pi$ \` by inversion on ($\Lambda E$) \\
(5) $\Gamma \vdash e' : \forall p.~\sigma$ \` by induction hypothesis (3,1) \\
(6) $\Gamma \vdash e'~\pi : \sigma[\pi/p]$ \` by ($\Lambda E$) (5,4) \\
\end{tabbing}

\item[Case:] $\ccase{e}{z{:}_{\overline{\Delta}}\sigma~\{\rho_i\to e'_i\}} \longrightarrow \ccase{e'}{z{:}_{\overline{\Delta}}\sigma~\{\rho_i\to e'_i\}}$
\begin{tabbing}
(1) $e \longrightarrow e'$ \` by inversion on case reduction \\
(2) $\Gamma, \Gamma' \vdash \ccase{e}{z{:}_{\overline{\Delta}}\sigma~\{\rho_i\to e'_i\}} : \varphi$ \` by assumption \\
(3) $\Gamma \vdash e : \sigma$ \` by inversion on case \\
% TODO: HOW i?
(4) $\overline{\Gamma', z{:}_{\Delta_i}\sigma \vdash_{alt} \rho_i \to e'_i : \varphi}$ \` by inversion on case \\
(5) $\Gamma \vdash e' : \sigma$ \` by induction hypothesis (3,1) \\
(6) $\Gamma, \Gamma' \vdash \ccase{e'}{z{:}_{\overline{\Delta}}\sigma~\{\rho_i\to e'_i\}} : \varphi$ \` by case (4,3) \\
\end{tabbing}

\end{description}

\end{proof}

